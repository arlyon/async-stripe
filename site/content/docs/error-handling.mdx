---
title: Error Handling
description: Understanding and handling Stripe API errors effectively
icon: TriangleAlert
---

import { Callout } from "fumadocs-ui/components/callout"
import { CodeFromFile } from "@/components/code-from-file"
import { EventParser } from "@/components/event-parser"

Stripe API requests can fail for various reasons: invalid parameters, authentication issues, card declines, rate limits, and network failures. The `StripeError` enum provides structured error information to help you handle these cases appropriately.

## Error Types

The `StripeError` enum has several variants:

<CodeFromFile
  file="async-stripe/src/error.rs"
  href={{base: "https://github.com/arlyon/async-stripe/blob/master/"}}
  lang="rust"
  startLine={7}
  endLine={25}
  dedent
/>

## Handling API Errors

The most common error type is `StripeError::Stripe`, which contains the error details from Stripe's API along with the HTTP status code.

### Basic Error Handling

<CodeFromFile
  file="examples/error-handling-basic.rs"
  href={{base: "https://github.com/arlyon/async-stripe/blob/master/"}}
  lang="rust"
  startLine={17}
  endLine={30}
  dedent
/>

### Handling Specific HTTP Status Codes

Different status codes indicate different types of failures:

<CodeFromFile
  file="examples/error-handling-status-codes.rs"
  href={{base: "https://github.com/arlyon/async-stripe/blob/master/"}}
  lang="rust"
  startLine={20}
  endLine={67}
  dedent
/>

## Common Error Codes

Stripe includes error codes in the `ApiErrors` struct that provide more specific information about what went wrong:

### Payment Errors (402)

- `card_declined` - The card was declined
- `expired_card` - The card has expired
- `incorrect_cvc` - The CVC is incorrect
- `processing_error` - An error occurred while processing the card
- `insufficient_funds` - Insufficient funds in the account

### Request Errors (400)

- `parameter_invalid_empty` - A required parameter was empty
- `parameter_unknown` - An unknown parameter was provided
- `resource_missing` - The requested resource doesn't exist

### Authentication Errors (401)

- `invalid_api_key` - The API key is invalid

<Callout type="info">
For a complete list of error codes, see the [Stripe Error Codes documentation](https://stripe.com/docs/error-codes).
</Callout>

## Parsing Errors

By default, `async-stripe` uses [`miniserde`](https://github.com/dtolnay/miniserde) for deserializing API responses. This significantly reduces compile times and binary size, but provides minimal error messages when deserialization fails.

### Understanding Deserialization Failures

If you receive a deserialization error, it may look like:

```
Error: failed to deserialize response
```

This typically means the JSON response from Stripe doesn't match the expected structure. This can happen when:

- Stripe adds new fields to their API
- You're using an outdated version of `async-stripe`
- The response contains unexpected values

### Getting Better Error Messages

For detailed diagnostics about which field failed and why, enable the `deserialize` feature to use `serde` instead:

```toml
[dependencies]
stripe-core = { version = "1.0.0-alpha.8", features = ["customer", "deserialize"] }
```

This provides comprehensive error context with `serde_path_to_error`, showing exactly where in the JSON structure the error occurred
 _at the cost of significantly increased compile times, link times, and binary size_. For context, the parser below needs 14MB just
 to parse webhook data.

<Callout type="warn" title="Why Not serde_json?">
The compile-time and binary size impact of `serde_json` is substantial due to monomorphization. Each generic serde function gets compiled separately for every type, leading to code bloat. With hundreds of Stripe types, this results in massive binaries and slow compile times, since stripe needs to generate X00,000 lines of code to define how to deserialize each type. `miniserde` avoids this by using trait objects instead of generics, dramatically reducing the amount of generated code. For a deep dive into this topic, see [The Dark Side of Inlining and Monomorphization](https://nickb.dev/blog/the-dark-side-of-inlining-and-monomorphization/).
</Callout>

### Testing Event Parsing

You can test how `async-stripe` parses Stripe events using the interactive parser below. This uses the actual async-stripe parser compiled to WebAssembly with `serde_path_to_error`, which reports exactly where deserialization failed:

<EventParser />

<Callout type="info">
See the [Performance](/docs/performance) documentation for more details on the hybrid serialization strategy and when to use the `deserialize` feature.
</Callout>

## Retry Strategies

For transient errors (network issues, server errors), use the built-in retry strategies:

<CodeFromFile
  file="examples/error-handling-retry.rs"
  href={{base: "https://github.com/arlyon/async-stripe/blob/master/"}}
  lang="rust"
  startLine={16}
  endLine={29}
  highlightLines={[2]}
  dedent
/>

See the [Request Strategies](/docs/request-strategy) documentation for more details on retry behavior.

## Best Practices

### 1. Handle Specific Errors

Don't just log all errors the same way. Handle payment failures differently from configuration errors:

<CodeFromFile
  file="examples/error-handling-best-practices.rs"
  href={{base: "https://github.com/arlyon/async-stripe/blob/master/"}}
  lang="rust"
  startLine={36}
  endLine={53}
  dedent
/>

### 2. Use Idempotency Keys

For critical operations (especially payment creation), always use idempotency keys to prevent accidental duplicate charges:

<CodeFromFile
  file="examples/error-handling-best-practices.rs"
  href={{base: "https://github.com/arlyon/async-stripe/blob/master/"}}
  lang="rust"
  startLine={64}
  endLine={78}
  dedent
/>

### 3. Log Error Details

The `ApiErrors` struct contains useful debugging information:

<CodeFromFile
  file="examples/error-handling-best-practices.rs"
  href={{base: "https://github.com/arlyon/async-stripe/blob/master/"}}
  lang="rust"
  startLine={83}
  endLine={94}
  dedent
/>

### 4. Don't Retry Client Errors

4xx errors (except 429 rate limits) usually indicate a problem with your request that won't be fixed by retrying. Only retry 5xx server errors and network failures.

The built-in `RequestStrategy::ExponentialBackoff` handles this correctly for you.

<Callout type="warn">
Never retry failed payments without user confirmation. A failed payment could be intentional (e.g., user canceled) or indicate fraud prevention.
</Callout>
